# 贡献指南

<cite>
**本文档引用的文件**  
- [README.md](file://README.md)
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [CHANGELOG.md](file://CHANGELOG.md)
- [src/lib.rs](file://src/lib.rs)
- [src/vcpu.rs](file://src/vcpu.rs)
- [src/context_frame.rs](file://src/context_frame.rs)
- [src/exception.rs](file://src/exception.rs)
- [src/smc.rs](file://src/smc.rs)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境设置](#开发环境设置)
3. [代码风格规范](#代码风格规范)
4. [测试策略](#测试策略)
5. [变更日志管理](#变更日志管理)
6. [提交信息格式](#提交信息格式)
7. [问题报告与功能请求](#问题报告与功能请求)
8. [拉取请求审查流程](#拉取请求审查流程)

## 简介

本贡献指南旨在为外部开发者提供清晰的参与流程，以便共同推进 `arm_vcpu` 项目的开发。`arm_vcpu` 是一个为 AArch64 架构设计的虚拟 CPU (vCPU) 实现，专用于超虚拟化环境。该项目提供了完整的 vCPU 结构、异常处理机制、硬件虚拟化支持以及安全监控调用 (SMC) 处理等功能。

通过遵循本指南，您可以确保您的贡献符合项目标准，提高代码审查效率，并促进项目的健康发展。无论您是修复 bug、添加新功能还是改进文档，本指南都将为您提供必要的指导。

**Section sources**
- [README.md](file://README.md#L1-L68)

## 开发环境设置

为了确保开发环境的一致性，`arm_vcpu` 项目使用 `rust-toolchain.toml` 文件来指定所需的 Rust 工具链版本和组件。请按照以下步骤正确设置您的开发环境：

1. **安装 Rustup**: 如果您尚未安装 Rust 包管理器，请访问 [rust-lang.org](https://www.rust-lang.org/tools/install) 安装 rustup。
2. **配置工具链**: 将项目根目录下的 `rust-toolchain.toml` 文件中的配置应用于您的本地环境。该文件指定了以下关键设置：
   - **通道 (channel)**: `nightly-2025-05-20`，这是一个特定日期的夜间构建版本，确保所有开发者使用相同的编译器特性。
   - **组件 (components)**: 包括 `rust-src`（Rust 源码）、`llvm-tools`（LLVM 工具）、`rustfmt`（代码格式化工具）和 `clippy`（代码 lint 工具），这些对于项目的编译和代码质量检查至关重要。
   - **目标 (targets)**: `aarch64-unknown-none-softfloat`，这是针对无操作系统 AArch64 架构的裸机目标，符合项目的 no_std 兼容性要求。

正确设置工具链后，Cargo 将自动使用指定的 nightly 版本进行构建，无需手动切换。这保证了所有贡献者的构建环境一致，避免了因工具链差异导致的编译问题。

**Section sources**
- [rust-toolchain.toml](file://rust-toolchain.toml#L1-L8)

## 代码风格规范

`arm_vcpu` 项目遵循严格的代码风格规范，以确保代码库的可读性和一致性。

### Unsafe 代码使用

由于 `arm_vcpu` 涉及底层系统编程和硬件交互，不可避免地需要使用 `unsafe` 代码块。然而，对 `unsafe` 的使用必须极其审慎。根据代码分析，`unsafe` 关键字在多个核心模块中被使用，包括上下文帧管理 (`context_frame.rs`)、异常处理 (`exception.rs`)、每核数据结构 (`pcpu.rs`) 和 SMC 接口 (`smc.rs`)。

使用 `unsafe` 时必须遵守以下原则：
- **明确注释**: 每个 `unsafe` 块都应附有详细的注释，解释为何此处需要 `unsafe` 以及如何保证其安全性。
- **最小化范围**: `unsafe` 块的作用域应尽可能小，仅包裹真正需要不安全操作的代码行。
- **隔离风险**: 高风险的 `unsafe` 操作应封装在独立的函数或模块中，并通过安全的 API 对外暴露。

### 文档注释

全面的文档注释对于理解复杂的系统级代码至关重要。项目中的公共 API，如 `Aarch64VCpu`、`TrapFrame` 和 `has_hardware_support` 函数，都应配备清晰的文档注释。注释应说明函数的功能、参数含义、返回值以及可能的错误情况。内部实现细节也应通过内联注释加以说明，特别是涉及硬件寄存器操作或复杂状态转换的部分。

**Section sources**
- [src/context_frame.rs](file://src/context_frame.rs#L212-L264)
- [src/exception.rs](file://src/exception.rs#L273-L355)
- [src/pcpu.rs](file://src/pcpu.rs#L26-L85)
- [src/smc.rs](file://src/smc.rs#L5-L14)
- [src/lib.rs](file://src/lib.rs#L29-L31)

## 测试策略

`arm_vcpu` 项目依赖于单元测试和集成测试来保证代码质量和功能正确性。

### 单元测试

每个模块都应包含充分的单元测试，验证其核心功能。例如，`vcpu.rs` 中的 `Aarch64VCpu` 结构体应有测试用例来验证其创建、配置和运行逻辑。单元测试应覆盖正常路径和边界条件。

### 集成测试

除了单元测试，项目还需要集成测试来验证不同组件之间的交互。例如，测试从异常发生到 SMC 调用再到返回的完整流程。CI 工作流（由 README.md 中的徽章指示）会自动运行这些测试，确保每次提交都不会破坏现有功能。

虽然当前代码库中未直接显示测试文件，但作为高质量的系统库，建立完善的测试套件是贡献的重要部分。新的功能或 bug 修复应伴随相应的测试用例。

**Section sources**
- [README.md](file://README.md#L1-L68)

## 变更日志管理

`CHANGELOG.md` 文件用于记录项目的重大变更，帮助用户了解版本间的区别。当您提交影响公共 API 或引入重要功能的更改时，必须更新此文件。

更新 `CHANGELOG.md` 的规则如下：
- **新增功能**: 在最新版本标题下添加 `- Added: <描述>` 条目。
- **Bug 修复**: 添加 `- Fixed: <描述>` 条目。
- **破坏性变更**: 明确标注 `- Breaking Change: <描述>`，并提供迁移指南。
- **版本号**: 遵循语义化版本控制 (SemVer)。例如，`0.1.1` 版本添加了对 4 级 EPT 的支持。

请确保您的条目简洁明了，让其他开发者能够快速理解变更内容。

**Section sources**
- [CHANGELOG.md](file://CHANGELOG.md#L1-L7)

## 提交信息格式

清晰的提交信息有助于追踪代码演变历史。`arm_vcpu` 项目采用约定式提交 (Conventional Commits) 格式，建议的格式为：`<type>(<scope>): <subject>`。

- **类型 (type)**: 如 `feat` (新功能), `fix` (bug 修复), `docs` (文档更新), `style` (代码格式调整), `refactor` (重构), `test` (测试相关), `chore` (杂项)。
- **范围 (scope)**: 可选，指明受影响的模块，如 `vcpu`, `exception`, `smc`。
- **主题 (subject)**: 简短的变更摘要。

例如：`feat(vcpu): add support for new exception type` 或 `fix(smc): correct register handling in smc_call`。

**Section sources**
- [src/vcpu.rs](file://src/vcpu.rs#L395)

## 问题报告与功能请求

我们鼓励社区成员通过 GitHub Issues 来报告 bug 和提出功能请求。

- **报告 Bug**: 创建一个新的 Issue，选择 "Bug report" 模板。请详细描述问题现象、复现步骤、预期行为和实际行为，并提供相关的环境信息（如 Rust 版本、目标平台）。
- **功能请求**: 创建一个新的 Issue，选择 "Feature request" 模板。清晰地阐述您希望添加的功能、其用途以及它将如何使项目受益。

在提交之前，请先搜索现有的 Issues，以避免重复。维护者会定期审查并回复这些请求。

## 拉取请求审查流程

提交拉取请求 (Pull Request, PR) 后，项目维护者将在 **3-5 个工作日** 内进行初步审查。审查过程可能包括：
- 代码功能是否符合需求
- 是否遵循代码风格和规范
- 是否有足够的测试覆盖
- 文档是否已相应更新

审查者可能会提出修改意见。请积极回应评论，并根据反馈完善您的 PR。一旦所有审查意见得到解决且 CI 测试通过，PR 将被合并到主分支。我们感谢每一位贡献者的努力，并致力于提供及时、建设性的反馈。